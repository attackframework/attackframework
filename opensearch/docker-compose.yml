services:
  opensearch:
    image: opensearchproject/opensearch:3.1.0
    container_name: ${NODE_NAME}
    env_file:
      - ../.env
    environment:
      - cluster.name=${CLUSTER_NAME}
      - node.name=${NODE_NAME}
      - bootstrap.memory_lock=true
      - OPENSEARCH_JAVA_OPTS=${OPENSEARCH_JAVA_OPTS}
      - DISABLE_INSTALL_DEMO_CONFIG=${DISABLE_INSTALL_DEMO_CONFIG}
      - DISABLE_SECURITY_PLUGIN=${DISABLE_SECURITY_PLUGIN}
      - OPENSEARCH_PUBLISH_HOST=${OPENSEARCH_PUBLISH_HOST}
    ulimits:
      memlock: { soft: -1, hard: -1 }
      nofile: { soft: 65536, hard: 65536 }
    volumes:
      - ./data:/usr/share/opensearch/data
      - ./logs:/usr/share/opensearch/logs
      - ./config/opensearch.yml:/usr/share/opensearch/config/opensearch.yml
      - ./config/opensearch-performance-analyzer:/usr/share/opensearch/config/opensearch-performance-analyzer
      - ../.env:/usr/share/opensearch/.env:ro
    ports:
      - "${OPENSEARCH_PORT}:9200"
      - "${OPENSEARCH_DIAGNOSTICS_PORT}:9600"
    networks:
      - opensearch-net
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep '\"status\":\"green\"'"]
      interval: 10s
      timeout: 10s
      retries: 5

networks:
  opensearch-net:
    driver: bridge
